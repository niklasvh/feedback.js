/*
 feedback.js <http://experiments.hertzen.com/jsfeedback/>
 Copyright (c) 2012 Niklas von Hertzen. All rights reserved.
 http://www.twitter.com/niklasvh

 Released under MIT License
*/
(function(e,t,n){if(e.Feedback!==n)return;var r=function(t){e.console.log(t)},i=function(e){for(var t=0,r=e.length;t<r;t++){var i=Array.prototype.pop.call(e);i!==n&&i.parentNode!==null&&i.parentNode.removeChild(i)}},s=function(){var e=t.createElement("div"),n=3;e.className="feedback-loader";while(n--)e.appendChild(t.createElement("span"));return e},o=function(e){return e.getBoundingClientRect()},u=function(e){var t;while((t=e.firstChild)!==null?e.removeChild(t):!1);},a=function(e,n){var r=t.createElement(e);return r.appendChild(t.createTextNode(n)),r},f=function(t,i){if(t.onload!==n)return i;if(t.onreadystatechange!==n){var s=function(){t.readyState!=="loaded"&&t.readyState!=="complete"?e.setTimeout(s,250):i()};e.setTimeout(s,250)}else r("ERROR: We can't track when script is loaded")},l,c="data-html2canvas-ignore",h,p=t.createElement("div");e.Feedback=function(r){r=r||{},r.label=r.label||"Send Feedback",r.header=r.header||"Send Feedback",r.url=r.url||"/",r.adapter=r.adapter||new e.Feedback.XHR(r.url),r.nextLabel=r.nextLabel||"Continue",r.reviewLabel=r.reviewLabel||"Review",r.sendLabel=r.sendLabel||"Send",r.closeLabel=r.closeLabel||"Close",r.messageSuccess=r.messageSuccess||"Your feedback was sent succesfully.",r.messageError=r.messageError||"There was an error sending your feedback to the server.",r.pages===n&&(r.pages=[new e.Feedback.Form,new e.Feedback.Screenshot(r),new e.Feedback.Review]);var o,f,h,d=t.createElement("div"),v={open:function(){var n=r.pages.length;h=0;for(;h<n;h++)r.pages[h]instanceof e.Feedback.Review||r.pages[h].render();var i=a("a","×"),s=t.createElement("div"),m=t.createElement("div");f=t.createElement("div"),t.body.appendChild(d),i.className="feedback-close",i.onclick=v.close,i.href="#",o.disabled=!0,s.appendChild(i),s.appendChild(a("h3",r.header)),s.className="feedback-header",p.className="feedback-body",u(p),h=0,p.appendChild(r.pages[h++].dom),l=a("button",r.nextLabel),l.className="feedback-btn",l.onclick=function(){if(h>0&&r.pages[h-1].end(f)===!1)return;u(p),h===n?v.send(r.adapter):(r.pages[h].start(f,s,m,l),r.pages[h]instanceof e.Feedback.Review&&r.pages[h].render(r.pages),p.appendChild(r.pages[h++].dom),h===n&&(l.firstChild.nodeValue=r.sendLabel),r.pages[h]instanceof e.Feedback.Review&&(l.firstChild.nodeValue=r.reviewLabel))},m.className="feedback-footer",m.appendChild(l),f.className="feedback-modal",f.setAttribute(c,!0),f.appendChild(s),f.appendChild(p),f.appendChild(m),o.parentNode.appendChild(f)},close:function(){o.disabled=!1,i([f,d]),h>0&&r.pages[h-1].end(f);for(var e=0,t=r.pages.length;e<t;e++)r.pages[e].close();return!1},send:function(n){if(!(n instanceof e.Feedback.Send))throw new Error("Adapter is not an instance of Feedback.Send");for(var i=0,o=r.pages.length,a=[],f=0,c;i<o;i++)(c=r.pages[i].data())!==!1&&(a[f++]=c);l.disabled=!0,u(p),p.appendChild(s()),n.send(a,function(e){u(p),l.disabled=!1,l.firstChild.nodeValue=r.closeLabel,l.onclick=function(){return v.close(),!1},e===!0?p.appendChild(t.createTextNode(r.messageSuccess)):p.appendChild(t.createTextNode(r.messageError))})}};d.className="feedback-glass",d.style.pointerEvents="none",d.setAttribute(c,!0),r=r||{},o=a("button",r.label),o.className="feedback-btn feedback-bottom-right",o.setAttribute(c,!0),o.onclick=v.open,(r.appendTo!==n?r.appendTo:t.body).appendChild(o)},e.Feedback.Page=function(){},e.Feedback.Page.prototype={render:function(e){this.dom=e},start:function(){},close:function(){},data:function(){return!1},review:function(){return null},end:function(){return!0}},e.Feedback.Send=function(){},e.Feedback.Send.prototype={send:function(){}},e.Feedback.Form=function(e){this.elements=e||[{type:"textarea",name:"Issue",label:"Please describe the issue you are experiencing",required:!1}],this.dom=t.createElement("div")},e.Feedback.Form.prototype=new e.Feedback.Page,e.Feedback.Form.prototype.render=function(){var e=0,n=this.elements.length,r;u(this.dom);for(;e<n;e++){r=this.elements[e];switch(r.type){case"textarea":this.dom.appendChild(a("label",r.label+":"+(r.required===!0?" *":""))),this.dom.appendChild(r.element=t.createElement("textarea"))}}return this},e.Feedback.Form.prototype.end=function(){var e=0,t=this.elements.length,n;for(;e<t;e++){n=this.elements[e];if(n.required===!0&&n.element.value.length===0)return n.element.className="feedback-error",!1;n.element.className=""}return!0},e.Feedback.Form.prototype.data=function(){if(this._data!==n)return this._data;var e=0,t=this.elements.length,r,i={};for(;e<t;e++)r=this.elements[e],i[r.name]=r.element.value;return this._data=i},e.Feedback.Form.prototype.review=function(e){var n=0,r,i=this.elements.length;for(;n<i;n++)r=this.elements[n],r.element.value.length>0&&(e.appendChild(a("label",r.name+":")),e.appendChild(t.createTextNode(r.element.value.length)),e.appendChild(t.createElement("hr")));return e},e.Feedback.Review=function(){this.dom=t.createElement("div"),this.dom.className="feedback-review"},e.Feedback.Review.prototype=new e.Feedback.Page,e.Feedback.Review.prototype.render=function(e){var t=0,n=e.length,r;u(this.dom);for(;t<n;t++)e[t].review(this.dom);return this},e.Feedback.Screenshot=function(e){this.options=e||{},this.options.blackoutClass=this.options.blackoutClass||"feedback-blackedout",this.options.highlightClass=this.options.highlightClass||"feedback-highlighted",this.h2cDone=!1},e.Feedback.Screenshot.prototype=new e.Feedback.Page,e.Feedback.Screenshot.prototype.end=function(e){e.className=e.className.replace(/feedback\-animate\-toside/,""),t.body.removeEventListener("mousemove",this.mouseMoveEvent,!1),t.body.removeEventListener("click",this.mouseClickEvent,!1),i([this.h2cCanvas]),this.h2cDone=!1},e.Feedback.Screenshot.prototype.close=function(){i([this.blackoutBox,this.highlightContainer,this.highlightBox,this.highlightClose]),i(t.getElementsByClassName(this.options.blackoutClass)),i(t.getElementsByClassName(this.options.highlightClass))},e.Feedback.Screenshot.prototype.start=function(r,i,f,l){if(this.h2cDone){u(this.dom),l.disabled=!1;var c=this,h="feedback-highlight-element",p="data-exclude",d=!0;this.mouseMoveEvent=function(t){if(t.target!==L&&(t.target.className.indexOf(c.options.blackoutClass)!==-1||t.target.className.indexOf(c.options.highlightClass)!==-1)){var s=parseInt(t.target.style.left,10)+parseInt(t.target.style.width,10);s=Math.max(s,10),s=Math.min(s,e.innerWidth-15);var u=parseInt(t.target.style.top,10);u=Math.max(u,10),m.style.left=s+"px",m.style.top=u+"px",w=t.target,x(),L=n;return}if(t.target.nodeName==="BODY"||t.target===m||t.target===r||t.target===l||t.target.parentNode===r||t.target.parentNode===i){x(),L=t.target;return}N(),t.target!==L&&(L=t.target,e.clearTimeout(v),v=e.setTimeout(function(){var t=o(L),n;d===!1?n=y:(n=g,n.width=t.width,n.height=t.height,E.drawImage(c.h2cCanvas,e.pageXOffset+t.left,e.pageYOffset+t.top,t.width,t.height,0,0,t.width,t.height)),n.setAttribute(p,!1),n.style.left=e.pageXOffset+t.left+"px",n.style.top=e.pageYOffset+t.top+"px",n.style.width=t.width+"px",n.style.height=t.height+"px"},100))},this.mouseClickEvent=function(e){e.preventDefault();if(d===!1){if(y.getAttribute(p)==="false"){var r=t.createElement("div");r.className=c.options.blackoutClass,r.style.left=y.style.left,r.style.top=y.style.top,r.style.width=y.style.width,r.style.height=y.style.height,t.body.appendChild(r),L=n}}else g.getAttribute(p)==="false"&&(g.className+=" "+c.options.highlightClass,g.className=g.className.replace(/feedback\-highlight\-element/g,""),c.highlightBox=g=t.createElement("canvas"),E=g.getContext("2d"),g.className+=" "+h,t.body.appendChild(g),x(),L=n)},this.highlightClose=a("div","×"),this.blackoutBox=t.createElement("div"),this.highlightBox=t.createElement("canvas"),this.highlightContainer=t.createElement("div");var v,m=this.highlightClose,g=this.highlightBox,y=this.blackoutBox,b=this.highlightContainer,w,E=g.getContext("2d"),S=function(e){e.preventDefault(),C.className.indexOf("active")===-1?(C.className+=" active",k.className=k.className.replace(/active/g,"")):(k.className+=" active",C.className=C.className.replace(/active/g,"")),d=!d},x=function(){T(y),T(g),e.clearTimeout(v)},T=function(e){e.style.left="-5px",e.style.top="-5px",e.style.width="0px",e.style.height="0px",e.setAttribute(p,!0)},N=function(){m.style.left="-50px",m.style.top="-50px"},C=a("a","Blackout"),k=a("a","Highlight"),L;r.className+=" feedback-animate-toside",m.id="feedback-highlight-close",m.addEventListener("click",function(){w.parentNode.removeChild(w),N()},!1),t.body.appendChild(m),this.h2cCanvas.className="feedback-canvas",t.body.appendChild(this.h2cCanvas);var A=[k,C];this.dom.appendChild(a("p","Highlight or blackout important information"));for(var O=0;O<2;O++)A[O].className="feedback-btn feedback-btn-small "+(O===0?"active":"feedback-btn-inverse"),A[O].href="#",A[O].onclick=S,this.dom.appendChild(A[O]),this.dom.appendChild(t.createTextNode(" "));b.id="feedback-highlight-container",b.style.width=this.h2cCanvas.width+"px",b.style.height=this.h2cCanvas.height+"px",this.highlightBox.className+=" "+h,this.blackoutBox.id="feedback-blackout-element",t.body.appendChild(this.highlightBox),b.appendChild(this.blackoutBox),t.body.appendChild(b),t.body.addEventListener("mousemove",this.mouseMoveEvent,!1),t.body.addEventListener("click",this.mouseClickEvent,!1)}else{var M=arguments,c=this;l.disabled!==!0&&this.dom.appendChild(s()),l.disabled=!0,e.setTimeout(function(){c.start.apply(c,M)},500)}},e.Feedback.Screenshot.prototype.render=function(){this.dom=t.createElement("div");var i,s=this,o=this.options,u=function(){try{o.onrendered=o.onrendered||function(e){s.h2cCanvas=e,s.h2cDone=!0},e.html2canvas([t.body],o)}catch(n){s.h2cDone=!0,r("Error in html2canvas: "+n.message)}};if(e.html2canvas===n&&i===n){i=t.createElement("script"),i.src=o.h2cPath||"libs/html2canvas.js",i.onerror=function(){r("Failed to load html2canvas library, check that the path is correctly defined")},i.onload=f(i,function(){if(e.html2canvas===n){r("Loaded html2canvas, but library not found");return}e.html2canvas.logging=e.Feedback.debug,u()});var a=t.getElementsByTagName("script")[0];a.parentNode.insertBefore(i,a)}else u();return this},e.Feedback.Screenshot.prototype.data=function(){if(this._data!==n)return this._data;if(this.h2cCanvas!==n){var e=this.h2cCanvas.getContext("2d"),r,i,s=5;e.fillStyle="#000",Array.prototype.slice.call(t.getElementsByClassName("feedback-blackedout"),0).forEach(function(t){var n=o(t);e.fillRect(n.left,n.top,n.width,n.height)});var u=Array.prototype.slice.call(t.getElementsByClassName("feedback-highlighted"),0);u.length>0&&(r=t.createElement("canvas"),i=r.getContext("2d"),r.width=this.h2cCanvas.width,r.height=this.h2cCanvas.height,i.drawImage(this.h2cCanvas,0,0),e.fillStyle="#777",e.globalAlpha=.5,e.fillRect(0,0,this.h2cCanvas.width,this.h2cCanvas.height),e.beginPath(),u.forEach(function(t){var n=parseInt(t.style.left,10),r=parseInt(t.style.top,10),i=parseInt(t.style.width,10),o=parseInt(t.style.height,10);e.moveTo(n+s,r),e.lineTo(n+i-s,r),e.quadraticCurveTo(n+i,r,n+i,r+s),e.lineTo(n+i,r+o-s),e.quadraticCurveTo(n+i,r+o,n+i-s,r+o),e.lineTo(n+s,r+o),e.quadraticCurveTo(n,r+o,n,r+o-s),e.lineTo(n,r+s),e.quadraticCurveTo(n,r,n+s,r)}),e.closePath(),e.clip(),e.globalAlpha=1,e.drawImage(r,0,0));try{return this._data=this.h2cCanvas.toDataURL()}catch(a){}}},e.Feedback.Screenshot.prototype.review=function(e){var t=this.data();if(t!==n){var r=new Image;r.src=t,r.style.width="300px",e.appendChild(r)}},e.Feedback.XHR=function(e){this.xhr=new XMLHttpRequest,this.url=e},e.Feedback.XHR.prototype=new e.Feedback.Send,e.Feedback.XHR.prototype.send=function(t,n){var r=this.xhr;r.onreadystatechange=function(){r.readyState==4&&n(r.status===200)},r.open("POST",this.url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("data="+encodeURIComponent(e.JSON.stringify(t)))}})(window,document);
